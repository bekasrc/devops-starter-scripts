#!/bin/bash
# ==============================================================
# Скрипт для ротации (архивации) логов, если они превысили размер
# Использование: ./log_rotator.sh <ПУТЬ_К_ЛОГ_ПАПКЕ> <МАКСИМАЛЬНЫЙ_РАЗМЕР_В_МБ>
# Пример: ./log_rotator.sh /tmp/my_service/logs 100
# ==============================================================

# 1. Переменные для входных аргументов
LOG_DIR=$1                      # Первый аргумент: Путь к папке с логами
MAX_SIZE_MB=$2                  # Второй аргумент: Максимальный размер (в МБ)
DATE=$(date +%Y%m%d_%H%M%S)     # Дата для имени архива

# 2. Проверка входных данных
if [ -z "$LOG_DIR" ] || [ -z "$MAX_SIZE_MB" ]; then
    echo "Ошибка: Укажите ПУТЬ и МАКСИМАЛЬНЫЙ_РАЗМЕР (в МБ)."
    echo "Пример использования: $0 /var/log/my_app 500"
    exit 1
fi

# Проверяем, существует ли папка
if [ ! -d "$LOG_DIR" ]; then
    echo "Ошибка: Директория логов $LOG_DIR не существует."
    exit 1
fi

# 3. Основная логика: Проверка размера
# Используем 'du -sm' для получения размера папки в Мегабайтах (-s: итог, -m: в МБ)
CURRENT_SIZE=$(du -sm "$LOG_DIR" | awk '{print $1}')
echo "Текущий размер логов в $LOG_DIR: $CURRENT_SIZE MB."

# 4. Условный оператор: Проверяем, превышен ли максимальный размер (-ge: greater or equal)
if [ "$CURRENT_SIZE" -ge "$MAX_SIZE_MB" ]; then
    echo "Размер $CURRENT_SIZE MB превышает лимит $MAX_SIZE_MB MB. Запускаем ротацию..."

    # 5. Действие: Архивация и очистка
    TAR_FILE="$LOG_DIR/archive_$DATE.tar.gz"
    
    # 5.1. Архивация всех файлов в папке (tar)
    tar -czf "$TAR_FILE" -C "$LOG_DIR" . 
    
    # 5.2. Проверка успешности архивации
    if [ $? -eq 0 ]; then
        echo "Архив успешно создан: $TAR_FILE"
        
        # 5.3. Очистка старых логов (настоящий ротатор обычно удаляет только старые файлы)
        # В этом примере мы просто создадим новый, пустой файл access.log для продолжения работы
        find "$LOG_DIR" -type f -name "*.log" -delete # Удаляем все .log файлы
        touch "$LOG_DIR/access.log"
        
        echo "Старые логи удалены. Новый access.log создан."
    else
        echo "ПРОВАЛ: Ошибка при архивации."
        exit 1
    fi
else
    echo "Размер логов в пределах нормы. Ротация не требуется."
fi

exit 0
